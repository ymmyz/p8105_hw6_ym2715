---
title: "P8105_hw6_ym2715"
author: "Yizhi Ma"
date: "11/26/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(modelr)
```

## Problem 1

```{r data loading and wrangling, message=FALSE, warning=FALSE}
homi_raw = read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")

homi = homi_raw 
homi$city_state = paste(homi$city, homi$state, sep = ", ")
homi = homi %>% 
  select(-city, -state) %>% 
  filter(city_state != "Dallas, TX",
         city_state != "Phoenix, AZ",
         city_state != "Kansas City, MO",
         city_state != "Tulsa, AL") %>% 
  mutate(victim_race = case_when(victim_race == "White" ~ "white",
                                 TRUE ~ "non-white"),
         victim_race = fct_relevel(victim_race, ref = "white"),
         victim_age = as.numeric(victim_age))
```

```{r logistic regression in Balto}
balto_glm = homi %>% 
  filter(city_state == "Baltimore, MD") %>% 
  mutate(disposition = case_when(disposition == "Closed by arrest" ~ 1,
                                 TRUE ~ 0))%>% 
  glm(disposition ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

balto_glm %>% broom::tidy(conf.int = TRUE)

balto_or_ci = balto_glm %>% 
  broom::tidy(conf.int = TRUE) %>% 
  mutate(odds_ratio = exp(estimate),
         conf_lower = exp(conf.low),
         conf_upper = exp(conf.high)) %>% 
  select(term, odds_ratio, conf_lower, conf_upper) %>% 
  filter(term == "victim_racenon-white")

```

```{r regression for each city, warning=FALSE}
each_city_glm = homi %>% 
  mutate(disposition = case_when(disposition == "Closed by arrest" ~ 1,
                                 TRUE ~ 0))%>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = map(data, ~glm(disposition ~ victim_age + victim_race + victim_sex, 
                                    data = ., family = binomial())),
         model_ci = map(model, broom::confint_tidy),
         model_tidy = map(model, broom::tidy)) %>% 
  select(-data, -model) %>% 
  unnest() %>% 
  filter(term == "victim_racenon-white") %>% 
  mutate(odds_ratio = exp(estimate), conf.low = exp(conf.low), conf.high = exp(conf.high)) %>% 
  select(city_state, odds_ratio, conf.low, conf.high)
```

```{r plot for each city}
each_city_glm %>% 
  arrange(odds_ratio) %>% 
  mutate(city_state = factor(city_state, unique(city_state))) %>% 
  ggplot(aes(x = city_state, y = odds_ratio)) +
  geom_point(alpha = 0.8) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), alpha = 0.4) +
  coord_flip() +
  labs(
    title = "Odds ratio and CIs for solved homicide cases in each city",
    x = "City, State",
    y = "Odds ratio (non-white vs white) and Confidence interval",
    caption = "data from The Washington Post "
  ) +
  theme_bw()+
  theme(axis.text.y = element_text(size = 6, hjust = 1)) 
```

## Problem 2

```{r data load and wrangling, message=FALSE}
birthweight_raw = read_csv("http://p8105.com/data/birthweight.csv")

birthweight_tidy = 
  birthweight_raw %>% 
  select(bwt, everything()) %>% 
  mutate(babysex = as.factor(case_when(babysex == 1 ~ "male",
                                       babysex == 2 ~ "female")),
         frace = as.factor(frace),
         mrace = as.factor(mrace),
         frace = recode(frace,
                        "1" = "White", "2" = "Black", "3" = "Asian", "4" = "Puerto Rican", "8" = "Other", "9" = "Unknown"),
         mrace = recode(mrace,
                        "1" = "White", "2" = "Black", "3" = "Asian", "4" = "Puerto Rican", "8" = "Other"))


```


